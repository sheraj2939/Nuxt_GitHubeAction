name: Test SendGrid Email

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sendgrid-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set environment variables
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}   # SendGrid API Key from GitHub Secrets
          EMAIL_FROM: devops@houzeo.com                        # Sender's email
          EMAIL_TO: sheraj.ahamad@houzeo.com                    # Recipient's email
          EMAIL_SUBJECT: "Test Email from GitHub Actions"      # Subject of the email
        run: |
          echo "SENDGRID_API_KEY is set."
          echo "EMAIL_FROM is set to $EMAIL_FROM"
          echo "EMAIL_TO is set to $EMAIL_TO"

      - name: Test SendGrid Email
        run: |
          echo "Sending test email to $EMAIL_TO"

          curl -v --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header "Content-Type: application/json" \
            --data '{
              "personalizations": [
                {
                  "to": [{"email": "'$EMAIL_TO'"}],
                  "subject": "'$EMAIL_SUBJECT'"
                }
              ],
              "from": {"email": "'$EMAIL_FROM'"},
              "content": [
                {
                  "type": "text/plain",
                  "value": "This is a test email to verify SendGrid API functionality."
                }
              ]
            }'

      - name: Check if SendGrid request was successful
        run: |
          echo "Checking SendGrid API response"
          curl -v --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header "Content-Type: application/json" \
            --data '{
              "personalizations": [
                {
                  "to": [{"email": "'$EMAIL_TO'"}],
                  "subject": "'$EMAIL_SUBJECT'"
                }
              ],
              "from": {"email": "'$EMAIL_FROM'"},
              "content": [
                {
                  "type": "text/plain",
                  "value": "This is a test email to verify SendGrid API functionality."
                }
              ]
            }'
          
          # Add a success or failure condition for email response
          if [ $? -eq 0 ]; then
            echo "Test email sent successfully!"
          else
            echo "Failed to send test email."
            exit 1
          fi
